{{- $internalRegistries := .Values.internalRegistries }}
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: restrict-external-images
  annotations:
    policies.kyverno.io/title: Restrict External Images
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      This policy restricts images to come from authorized external registries and organizations,
      while allowing defined internal registries by default.
spec:
  validationFailureAction: {{ .Values.policy.validationFailureAction }}
  background: {{ .Values.policy.background }}
  rules:
    - name: check-image-registry
      match:
        any:
        - resources:
            kinds:
              - Pod
      # Precondition: Skip validation (allow) if image is from internal registry
      # We iterate over containers, so we check this per-image in the foreach loop below.
      context: 
        - name: registriesData
          configMap:
            name: allowed-registries
            namespace: kyverno
            key: registries
      validate:
        foreach:
          - list: "request.object.spec.containers"
            # Preconditions to skip internal registries
            preconditions:
              all:
              - key: "{{ "{{" }} to_string(element.image) | split(@, '/') | [0] | (contains(@, '.') || contains(@, ':') || @ == 'localhost') && @ || 'docker.io' }}"
                operator: AnyNotIn
                value: {{ $internalRegistries | toJson }}
            validate:
              message: "Image {{ "{{" }} element.image }} is not from an allowed external registry or organization."
              deny:
                conditions:
                  all:
                  # Variable definition for readability and reuse logic in deny block
                  - variable: image_registry
                    key: "{{ "{{" }} to_string(element.image) | split(@, '/') | [0] | (contains(@, '.') || contains(@, ':') || @ == 'localhost') && @ || 'docker.io' }}"
                  
                  - variable: image_repo_path
                    # If registry was implicit (docker.io), the repo path is the full image string.
                    # If explicit, it is everything after the first slash.
                    key: "{{ "{{" }} image_registry == 'docker.io' && !contains(split(element.image, '/')[0], '.') && !contains(split(element.image, '/')[0], ':') && split(element.image, '/')[0] != 'localhost' && element.image || join('/', split(element.image, '/')[1:]) }}"

                  - variable: image_org
                    # Normalize 'library' for docker.io if no slash in repo path
                    key: "{{ "{{" }} image_registry == 'docker.io' && !contains(image_repo_path, '/') && 'library' || split(image_repo_path, '/')[0] }}"
                  
                  # Check if the registry exists in the ConfigMap AND the organization is allowed
                  - key: "{{ "{{" }} (parse_yaml(registriesData)[image_registry] || `[]`) | contains(@, image_org) }}"
                    operator: Equals
                    value: true
